<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prüfung</title>
   
    <!--bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <!-- jquerry-->
    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script -->

     <!--font-awesome-icons-->   
    <script src="https://kit.fontawesome.com/3d2d5ca0b3.js" crossorigin="anonymous"></script>

    <!--css-stylesheet-->
    <link href="./schuelerView.css" rel="stylesheet">

</head>
<body>
    <div class="container-fluid" id="content-wrapper">
        <div class="row" id="top-bar-row">
            <h1>Prüfung</h1>
        </div>

        <div class="container main-content-wrapper">
            
            <div class="row info-row">
                <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-xs-12 schueler-data">
                    <label>Schülernummer: </label>
                    <input class="schueler-data-input" type="text" id="input_schuelernummer" maxlength="4">
                    <label class="mt-1">Klasse: </label>
                    <select class="schueler-data-input" id="selected_klasse">
                        <option selected disabled>Klasse auswählen</option>
                        <option>FI203</option>
                        <option>FI213</option>
                        <option>FI201</option>
                    </select>
                </div>

                <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-xs-12 legende">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Antwort</th>
                                <th>Bedeutung</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>0</td>
                                <td>KEINE Aussage IST RICHTIG</td>
                            </tr>
                            <tr>
                                <td>1</td>
                                <td>1. Aussage IST RICHTIG</td>
                            </tr>
                            <tr>
                                <td>2</td>
                                <td>2. Aussage IST RICHTIG</td>
                            </tr>
                            <tr>
                                <td>3</td>
                                <td>BEIDE Aussagen IST RICHTIG</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="row aufgaben-row">
                <!--aufgabe container-->
                <div class="container aufgabe-wrapper mt-4">
                    <div class="aussage-row">
                        <label class="number">1.</label>
                        <p class="text aussage">Das ist eine erste dummy Aussage, die keine Bedeutung hat.</p>
                    </div>
                    <div class="aussage-row">
                        <label class="number">2.</label>
                        <p class="aussage">Das ist eine zweite dummy Aussage, die keine Bedeutung hat.</p>
                    </div>
                    <div class="antworten-row">
                        <div class="col-3 antwort">0</div>
                        <div class="col-3 antwort">1</div>
                        <div class="col-3 antwort">2</div>
                        <div class="col-3 antwort">3</div>
                    </div>
                </div>
                <!--aufgabe container-->
                <div class="container aufgabe-wrapper mt-4">
                    <div class="aussage-row">
                        <label class="number">1.</label>
                        <p class="text aussage">Das ist eine erste dummy Aussage, die keine Bedeutung hat.</p>
                    </div>
                    <div class="aussage-row">
                        <label class="number">2.</label>
                        <p class="aussage">Das ist eine zweite dummy Aussage, die keine Bedeutung hat.</p>
                    </div>
                    <div class="antworten-row">
                        <div class="col-3 antwort">0</div>
                        <div class="col-3 antwort">1</div>
                        <div class="col-3 antwort">2</div>
                        <div class="col-3 antwort">3</div>
                    </div>
                </div>
                <!--beispielhaft-->
                <p>...</p>
                <p>...</p>
                <p>...</p>
                <!--aufgabe container-->
                <div class="container aufgabe-wrapper mt-4">
                    <div class="aussage-row">
                        <label class="number">1.</label>
                        <p class="text aussage">Das ist eine erste dummy Aussage, die keine Bedeutung hat.</p>
                    </div>
                    <div class="aussage-row">
                        <label class="number">2.</label>
                        <p class="aussage">Das ist eine zweite dummy Aussage, die keine Bedeutung hat.</p>
                    </div>
                    <div class="antworten-row">
                        <div class="col-3 antwort">0</div>
                        <div class="col-3 antwort">1</div>
                        <div class="col-3 antwort">2</div>
                        <div class="col-3 antwort">3</div>
                    </div>
                </div>
            </div>

            <div class="row actions-row">
                <div class="submit-wrapper mt-5">
                    <button class="btn btn-primary abgeben-btn" type="submit" id="pruefung-submit-btn">Abgeben!</button>
                </div>
            </div>
        </div>
    </div>
    <!--bootstrap-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>

<script>
    // Hole die Quiz-ID aus der URL
    const urlParams = new URLSearchParams(window.location.search);
    const quizID = Number(urlParams.get('quizID')) || 0; // Setzt 0, wenn kein Wert da ist

    // Funktion zum Abrufen der Quiz-Daten
    async function loadQuiz_Prüfung() {
        try {
            const response = await fetch(`http://127.0.0.1:8000/quizze/${quizID}`);
            const data = await response.json();

            if (data.status === "success") {
                displayQuiz(data.data);
            } else {
                alert("Fehler beim Laden des Quiz.");
            }
        } catch (error) {
            console.error("Fehler:", error);
        }
    }

    // Funktion zum Anzeigen der Quiz-Daten
    function displayQuiz(quiz) {
        const aufgabenContainer = document.querySelector(".aufgaben-row");
        aufgabenContainer.innerHTML = ""; // Leere den Container

        quiz.Aufgaben.forEach((aufgabe, index) => {
            const aufgabeHTML = `
                <div class="container aufgabe-wrapper mt-4">
                    <div class="aussage-row">
                        <label class="number">1.</label>
                        <p class="text aussage">${aufgabe.aussage1}</p>
                    </div>
                    <div class="aussage-row">
                        <label class="number">2.</label>
                        <p class="aussage">${aufgabe.aussage2}</p>
                    </div>
                    <div class="antworten-row">
                        <div class="col-3 antwort" data-aufgabeid="${aufgabe.aufgabeID}" data-antwort="0">0</div>
                        <div class="col-3 antwort" data-aufgabeid="${aufgabe.aufgabeID}" data-antwort="1">1</div>
                        <div class="col-3 antwort" data-aufgabeid="${aufgabe.aufgabeID}" data-antwort="2">2</div>
                        <div class="col-3 antwort" data-aufgabeid="${aufgabe.aufgabeID}" data-antwort="3">3</div>
                    </div>
                </div>
            `;
            aufgabenContainer.innerHTML += aufgabeHTML;
        });

        // Event-Listener für Antworten hinzufügen
        document.querySelectorAll(".antwort").forEach(antwort => {
            antwort.addEventListener("click", () => {
                // Markiere die ausgewählte Antwort
                document.querySelectorAll(`[data-aufgabeid="${antwort.dataset.aufgabeid}"]`).forEach(a => {
                    a.classList.remove("selected");
                });
                antwort.classList.add("selected");
            });
        });
    }

    // Funktion zum Senden der Antworten
    async function submitAnswers() {
        const schuelernummer = document.getElementById("input_schuelernummer").value;
        const klasse = document.getElementById("selected_klasse").value;

        if (!schuelernummer || !klasse) {
            alert("Bitte geben Sie Ihren Schülernummer und Ihre Klasse ein.");
            return;
        }

        // Sammle die Antworten
        const antworten = [];
        document.querySelectorAll(".antwort.selected").forEach(antwort => {
            antworten.push({
                aufgabeID: parseInt(antwort.dataset.aufgabeid),
                auswahl: parseInt(antwort.dataset.antwort)
            });
        });

        if (antworten.length === 0) {
            alert("Bitte beantworten Sie alle Fragen.");
            return;
        }

        try {
            // Erstelle einen neuen Teilnehmer
            const teilnehmerResponse = await fetch("http://127.0.0.1:8000/quizze/teilnehmern/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    schuelernummer: schuelernummer,
                    klasse: klasse
                })
            });
            const teilnehmerData = await teilnehmerResponse.json();

            if (teilnehmerData.status !== "success") {
                throw new Error("Fehler beim Erstellen des Teilnehmers.");
            }

            const teilnehmerID = teilnehmerData.data.T_ID;
            // Sende die Antworten
            const antwortenResponse = await fetch(`http://127.0.0.1:8000/quizze/${quizID}/pruefung/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    quizID: quizID,
                    teilnehmerID: teilnehmerID,
                    antworten: antworten
                })
            });
            const antwortenData = await antwortenResponse.json();

            if (antwortenData.status === "success") {
                alert(`${antwortenData.data.msg}`);
            } else {
                alert("Fehler beim Überprüfen der Antworten.");
            }
        } catch (error) {
            console.error("Fehler:", error);
            alert("Ein Fehler ist aufgetreten: " + error);
        }
    }

    // Event-Listener für den Abgeben-Button
    document.getElementById("pruefung-submit-btn").addEventListener("click", submitAnswers);

    // Lade das Quiz, wenn die Seite geladen wird
    window.addEventListener("load", loadQuiz_Prüfung);
</script>